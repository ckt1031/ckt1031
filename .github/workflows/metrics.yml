name: Metrics

on:
  # Schedule daily updates
  schedule:
    # Runs at 18:00 UTC
    # Runs at 02:00 HKT
    - cron: "0 18 * * *"
  # Run workflow manually
  workflow_dispatch:

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash
        
      - name: Setup rclone config
        # Create the rclone config directory and decode the base64 secrets
        # Note: Ensure RCLONE_CONFIG_BASE64 is your base64 encoded rclone.conf file
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: Generate Metrics SVG
        # Run the ghcr.io/lowlighter/metrics Docker container.
        # Docker will check if 'latest' is updated and only pull new layers if necessary,
        # otherwise, it uses the cached image layers.
        run: |
          docker run --rm \
            --env INPUT_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
            --env INPUT_USER=ckt1031 \
            --env INPUT_PLUGIN_LANGUAGES=yes \
            --env INPUT_PLUGIN_LANGUAGES_INDEPTH="yes" \
            --env INPUT_PLUGIN_LANGUAGES_IGNORED="css, tsx, jsx, html, md, mdx" \
            --volume=/tmp:/renders \
            ghcr.io/lowlighter/metrics:latest
            
      - name: Upload to S3
        # Use rclone to copy the generated SVG to your S3-compatible storage (R2/Cloudflare, AWS S3, etc.)
        # Make sure 'r2-common' matches the remote name in your rclone.conf
        # And 'common' is the bucket name.
        run: |
          rclone copy /tmp/github-metrics.svg r2-common:common/github --s3-no-check-bucket
